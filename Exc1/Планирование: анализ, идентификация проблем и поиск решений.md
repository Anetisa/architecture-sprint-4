# Планирование: анализ, идентификация проблем и поиск решений


### Идентифицируем существующие и потенциальные проблемные места. 

**1. Отсутствует мониторинг и логирование**
- Отсутствие явного механизма мониторинга и логирования для обнаружения сбоев.
- Нет единого механизма для отслеживания ошибок API, задержек (latency), количества запросов (RPS).
- Без мониторинга невозможно оперативно выявлять проблемные эндпоинты и узкие места в API.
- Ошибки 500 и 400 могут оставаться незамеченными, если их не логировать централизованно.
- Что происходит, если Messages Queue (RabbitMQ) перестает работать? Непрозрачность работы RabbitMQ приводит к проблемам при диагностике зависших заказов.
   
Возможные последствия:
- Задержки в API негативно скажутся на обработке заказов.
- Невозможность быстрой диагностики сбоев в реальном времени.
- Увеличение времени простоя и негативный клиентский опыт.

**2. Проблемы масштабируемости и отказоустойчивости**
- Одиночные инстансы всех сервисов   
	- Все компоненты системы (Shop API, CRM API, MES API) работают на одном инстансе, что создаёт узкие места в производительности и отказоустойчивости.   
Если один из них выходит из строя, система частично или полностью перестаёт работать.   
	- При росте нагрузки сервисы не масштабируются автоматически. **Система не справляется с увеличением нагрузки.** _В среднем каждый месяц «Александрит» получает на 100 заказов больше, чем в предыдущий._ Но система явно не масштабируется пропорционально. 
- Базы данных (Shop DB и MES DB) также работают на одном инстансе
	- Нет репликации БД, что может привести к деградации производительности при росте количества запросов.
    - Возможна потеря данных в случае сбоя инстанса.
- RabbitMQ (Messages Queue) – узкое место системы
	-  Если очередь сообщений перегружается или выходит из строя, система перестаёт корректно обрабатывать заказы.   
Взаимодействие между MES и CRM построено на RabbitMQ, поэтому увеличение объёма заказов может привести к накоплению сообщений в очередях.
	- Потеря сообщений приводит к тому, что CRM не получает обновления заказов своевременно.
	- Отсутствие механизма повторного выполнения заданий при сбоях.
- Обработка 3D-файлов
	- 3D files storage (S3-based storage) может быть узким местом, если файлы большие или требуется сложная обработка.
    - Возможны задержки при загрузке и передаче файлов в зависимости от сети.

**3.Проблемы с MES.**
- Долгая загрузка первой страницы MES. Операторы жалуются, что система загружается слишком долго, что замедляет их работу.    
В MES отображается большой список заказов без эффективного механизма загрузки.
	- Фильтр и пагинация не помогли. _Команда сделала фильтр по статусам и пагинацию, но это не помогло_ , проблема с производительностью остаётся.
	- Операторам важно видеть свежие заказы, но система загружается слишком долго.
- MES API обрабатывает расчёты стоимости на своей стороне.
	- Расчёт стоимости в среднем занимает 2-3 минуты. Скорость расчёта зависит от количества полигонов в 3D-модели. Если модель сложная и детализированная, время обработки может достигать 30 минут.
	- Высокая нагрузка на этот сервис может замедлять работу всего MES.
	
**4.Проблемы с процессами разработки и релизами**  
- Ручное тестирование замедляет выпуск новых версий. QA-инженер тестирует вручную, а при обнаружении критических багов релиз задерживается.
- Увеличение времени на выпуск релизов. Задержки релизов стали частыми, что мешает оперативно решать проблемы.

**5.Проблемы с клиентами и бизнесом**
- Задержки в выполнении заказов
	+ Клиенты не получают заказы вовремя — обработка может длиться несколько месяцев вместо 3 недель. Проблема не на стороне производства, а в процессе обработки заказов.
- Недовольство B2B-клиентов API
	+ Компании, использующие API, теряют заказы из-за отсутствия SLA и прозрачности.
	+ Жалобы со стороны партнёров привели к потере крупных контрактов.
- Отсутствие механизма приоритизации заказов
- CRM не обновляет статусы заказов в реальном времени
	+ Покупатели и продавцы не видят актуальный статус заказа, что вызывает рост недовольства.

### Инициативы для устранения нежелательных ситуаций в Jewelry Store System

**1.Мониторинг, логирование и трейсинг**
- Централизованный мониторинг инфраструктуры и сервисов
	+ Настроить Prometheus + Grafana для мониторинга нагрузки, базы данных, RabbitMQ.
	+ Включить алерты на аномалии (длительный расчёт цен, зависшие заказы, проблемы с API).
- Централизованное логирование
	+ Внедрить ELK-стек (Elasticsearch, Logstash, Kibana) для логирования.
	+ Логировать ключевые статусы заказов и взаимодействие сервисов.
- Трейсинг для анализа задержек
	+ Подключить OpenTelemetry или Jaeger для трассировки вызовов API.
	+ Определять узкие места в обработке заказов.
	   
**2. Масштабирование инфраструктуры и повышение отказоустойчивости** 
- Горизонтальное масштабирование сервисов 
	+ Развернуть несколько инстансов для Shop API, CRM API, MES API с балансировкой нагрузки.
	+ Автоматическое масштабирование сервисов (настроить Kubernetes или Docker Swarm для управления нагрузкой).
- Масштабирование баз данных
	+ Добавить реплику БД для разгрузки чтения (Shop DB, MES DB).
	+ Настроить автоматическое переключение на резервный инстанс в случае сбоя.
- Кластеризация RabbitMQ
	+ Развернуть кластер RabbitMQ для балансировки нагрузки и отказоустойчивости.
	+ Включить DLQ для обработки "зависших" сообщений.
	+ Настроить retry-механику для автоматического повторного запроса сообщений.
	
**3. Оптимизация MES и обработки заказов**
- Оптимизация главной страницы MES
	+ Реализовать ленивую загрузку (Lazy Loading) заказов.
	- Ограничить по умолчанию отображение N свежих заказов.
	- Хранить часто запрашиваемые данные в Redis для быстрого доступа.
- Оптимизация расчёта стоимости заказов
	+ Кэшировать ранее рассчитанные цены через Redis
	+ Разделить расчёты на асинхронные задачи
	+ Ввести приоритетную обработку сложных заказов 
- Приоритизация заказов
	- Внедрить очередь заказов по SLA, где старые заказы автоматически получают высокий приоритет.
	- Автоматически распределять заказы между операторами с учётом загрузки.

**4. Улучшение API для B2B-клиентов**
-  Введение SLA для API
	- Определить гарантированные сроки обработки заказов для пользователей API.
	- Настроить мониторинг API (например, через Prometheus + Grafana).
- Добавление механизма обработки задержек
	+ Если заказ не обработан в срок, автоматически переводить его в повышенный приоритет.
	+ Внедрить систему авто-уведомлений для B2B-партнёров о задержках.

**5.Оптимизация хранения 3D-файлов**   
- Кэширование часто используемых 3D-файлов (использовать Redis для быстрого доступа).
- Облачное хранилище с CDN 
- Сжатие и оптимизация файлов перед хранением (применение GLTF вместо OBJ для уменьшения размера файлов).

**6. Автоматизация процессов разработки и релизов**
-  Автоматизация тестирования
	+  Внедрить авто-тесты для API и UI 
	+  Использовать CI/CD-пайплайн с автоматическим прогоном тестов.
- Ускорение релизов и развертываний
	+ Внедрить канареечные деплои и тестирование на небольшой группе пользователей.
	+ Добавить авто-откат релиза в случае обнаружения критических багов.

**7. Расширение команды:**
- Найм дополнительных специалистов:
	- Frontend (React) – для оптимизации MES.
	- Backend (C# / Java) – для оптимизации API и RabbitMQ.
	- DevOps-инженер – для работы с масштабированием и мониторингом.


### Приоритизация инициатив для Jewelry Store System 

Для определения приоритетов я рассматриваю следующие критерии:
- Критичность для бизнеса – насколько сбой в этом компоненте повлияет на работу системы и доход.
- Сложность внедрения – как быстро можно реализовать изменения и насколько это повлияет на текущий процесс.
- Влияние на пользовательский опыт – улучшает ли это удобство для клиентов, продавцов и операторов.
- Отказоустойчивость и масштабируемость – насколько это повысит надежность системы в условиях роста нагрузки.
    
**1. Критический уровень (делаем в первую очередь, иначе бизнес продолжит терять деньги и клиентов)**  
- Централизованный мониторинг (Prometheus + Grafana) и алерты на зависшие заказы
- Горизонтальное масштабирование сервисов (Shop API, CRM API, MES API)
- Оптимизация главной страницы MES (ленивая загрузка, кеширование, ограничение количества заказов)
- Улучшение информирования клиентов (уведомления о статусе заказов, WebSockets, API для B2B-партнёров)

**2. Высокий уровень (реализуем сразу после критического, чтобы улучшить эффективность работы системы и снизить нагрузку)**
- Масштабирование баз данных (реплика для чтения, failover на случай сбоя)
- Оптимизация расчёта стоимости заказов (кеширование, асинхронные задачи, приоритетная обработка сложных заказов)
- Автоматизация тестирования 
- Оптимизация взаимодействия между сервисами (Shop API ↔ MES API, событийная архитектура вместо RabbitMQ в узких местах)

**3.Средний уровень (улучшения, которые ускорят и сделают систему устойчивее, но не критичны для бизнеса прямо сейчас)**
- Централизованное логирование (ELK-стек, Logstash, Kibana)
- Трейсинг для анализа задержек (OpenTelemetry, Jaeger)
- Внедрение механизма приоритизации заказов (авто-распределение, SLA)
- Ускорение релизов и деплоев (канареечные релизы, авто-откат при ошибках)
- Оптимизация хранения 3D-файлов

**4. Низкий уровень (можно делать постепенно, параллельно с другими задачами, если останется время)**
- Кластеризация RabbitMQ (балансировка, dead-letter queue, retry-механика)
- Расширение команды (наём backend, frontend, DevOps-инженеров)
- Введение SLA для API-пользователей (гарантированные сроки, мониторинг API-запросов)


**Целевая архитектура через полгода должна:**
- **Быть наблюдаемой и предсказуемой** → Полноценный мониторинг, логирование, трейсинг, SLA для API.
- **Быть масштабируемой и отказоустойчивой** → Авто-масштабируемые инстансы сервисов и БД, кластер RabbitMQ.
- **Обеспечивать быструю обработку заказов** → Оптимизированные API, кеширование расчётов, улучшенная MES.
- **Гарантировать прозрачность для клиентов** → SLA, уведомления, WebSockets, API-статусы.
- **Обеспечивать быстрые и стабильные релизы** → CI/CD, автоматизированное тестирование.

**Если бы я могла выполнить только 3 инициативы за полгода, я бы выбрала:**
- Централизованный мониторинг (Prometheus + Grafana, алерты на зависшие заказы)   
_Это позволит раньше реагировать на проблемы, предотвращая потери заказов и клиентов._   
- Повышение отказоустойчивости API и базы данных. Горизонтальное масштабирование сервисов (Shop API, CRM API, MES API)
_Без этого система продолжит падать под нагрузкой, задержки в заказах будут расти.   
База данных и API – основа всей системы. Если они работают нестабильно, ни одна другая инициатива не имеет смысла._
- Оптимизация главной страницы MES (ленивая загрузка, кеширование, ограничение количества заказов)   
_Без этого операторы не смогут эффективно работать, что напрямую влияет на скорость выполнения заказов._

Почему именно эти три инициативы?
- Они дадут быстрый эффект (результат уже в первые 2-3 месяца).
- Они критичны для стабильной работы бизнеса (помогут обработать больше заказов, снизить жалобы клиентов).
 - Без них остальные инициативы не принесут пользы (например, оптимизация RabbitMQ бессмысленна, если серверы не масштабируются).

Дополнительно:
- Если останется время, можно параллельно начать автоматизацию тестирования и оптимизацию расчётов в MES.

